var DB = require('models/mysqlConnection');

var User = function() {

	this.subscribeUser = function(request, callback) {
		var pseudo = request.pseudo;
		var password = request.password;

		if (pseudo != '' && password != '')
		{
			DB.query('INSERT INTO users (pseudo, password) VALUES ("'+pseudo+'", "'+password+'")', function(err, result)
			{
				if (err)
					throw err;
				else
				{
					callback("ok");
				}
			});
		}
		else
		{
			console.log('user cannot be subscribed');
			callback("error");
		}
	},

	this.loginUser = function(request, callback) {
		var pseudo = request.pseudo;
		var password = request.password;

		if (pseudo != '' && password != '')
		{
			DB.query('SELECT * FROM users WHERE pseudo = "'+pseudo+'" AND password = "'+password+'"', function(err, rows, fields)
			{
				if (err)
					throw err;
				else
				{
					if (rows)
						callback(rows[0]);
					else
						callback("error");
				}
			});
		}
		else
		{
			console.log('user cannot be subscribed');
			callback("error");
		}
	},

	this.getFriendsList = function(session, bool, callback) {

		var user_id = session.user_id;
		if (bool)
			user_id = session;

		var query = 'SELECT id_user1, id_user2 FROM friends WHERE (id_user1 = "'+user_id+'" OR id_user2 = "'+user_id+'")';
		DB.query(query, function(err, rows, fields) {

			if (rows)
			{
				var ch = "";
				for (var i = 0; i < rows.length; i++)
				{
					var id_to_get = rows[i].id_user1;
					if (id_to_get == user_id)
						id_to_get = rows[i].id_user2;
					ch += id_to_get + ',';
				}
				ch = ch.slice(0, -1);

				var subQuery = 'SELECT id, pseudo FROM users WHERE id IN (' + ch + ')';
				DB.query(subQuery, function(err, finalRows, fields) {
					if (finalRows)
						callback(finalRows);
				});

			}
		});
	}
}

module.exports = User;