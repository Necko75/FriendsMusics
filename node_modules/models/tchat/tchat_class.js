/* TABLE tchat_messages, [id, id_user_sender, id_user_receiver, message] */

var DB = require('models/mysqlConnection');

var Tchat = {

	insertMessage : function(id_user_sender, id_user_receiver, message) {

		var query = 'INSERT INTO tchat_messages (id_user_sender, id_user_receiver, message) VALUES ("'+id_user_sender+'","'+id_user_receiver+'", "'+message+'")';
		DB.query(query, function(err, rows, fields) {

			if (!err)
			{
				;
			}
		});
	},

	getOldMessages : function(params, session, callback) {

		var query = 'SELECT * FROM tchat_messages WHERE (id_user_sender = "'+session.user_id+'" AND id_user_receiver = "'+params.id+'") OR (id_user_sender = "'+params.id+'" AND id_user_receiver = "'+session.user_id+'") ORDER BY (tchat_messages.id) DESC limit 20';
		DB.query(query, function(err, rows, fields) {

			if (!err)
			{
				callback(rows.reverse());
			}
		});
	},

	insertShareSongNotifications : function(id_user_sender, id_user_receiver, song_id) {

		var query = 'INSERT INTO shared_songs (id_user_sender, id_user_receiver, id_song) VALUES ("'+id_user_sender+'", "'+id_user_receiver+'", "'+song_id+'")';
		DB.query(query, function(err, rows, fields) {
			;
		});
	},

	getThreadListMessages : function(session, callback) {

		var query = 'SELECT users.id as id, users.pseudo, tchat_messages.message FROM (SELECT id_user_sender, MAX(id) as max_id FROM tchat_messages WHERE id_user_receiver = "'+session.user_id+'" GROUP BY id_user_sender) as last_message JOIN tchat_messages ON tchat_messages.id_user_sender=last_message.id_user_sender AND tchat_messages.id=last_message.max_id JOIN users ON tchat_messages.id_user_sender = users.id ORDER BY tchat_messages.id DESC;';
		DB.query(query, function(err, rows, fields) {

			console.log(rows);
			callback(rows);
		});
	}
}

module.exports = Tchat;